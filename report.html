<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ORA Final Project Notebook Report</title>
<style>
body { font-family: "Segoe UI", Arial, sans-serif; margin: 2rem; line-height: 1.6; }
h1, h2, h3 { color: #0b5394; }
code { background: #f4f4f4; padding: 0.15rem 0.35rem; border-radius: 4px; }
ul { margin-bottom: 1rem; }
.section { margin-bottom: 2.5rem; }
.highlight { background: #fff3cd; padding: 0.75rem; border-left: 4px solid #ff9900; }
.table-like { border: 1px solid #ddd; border-radius: 6px; padding: 0.75rem; margin-top: 0.5rem; }
.table-like h4 { margin-top: 0; }
</style>
</head>
<body>
<h1>ORA Final Project Notebook Report</h1>
<p>This report summarizes the two primary notebooks (<code>code.ipynb</code> and <code>continuous_models.ipynb</code>) and the datasets they rely on. It explains each analytical module, the optimization models that are solved, and the performance indicators that the notebooks emit.</p>

<div class="section">
<h2>Data Sources and Configuration</h2>
<div class="table-like">
<h3>Discrete Scenario Data: <code>hospital_disaster_dataset.csv</code></h3>
<ul>
  <li>Generated by <code>dataset.py</code> and covers three facilities (Central, North, South).</li>
  <li>Contains eight hand-crafted scenarios (S0–S7) that span calm operations through multi-wave disasters.</li>
  <li>Each scenario provides a probability, disaster label, per-hospital demand, handling cost, and a uniform shortage penalty of 8.</li>
  <li>A total pre-positioned stock cap of 220 drives the deterministic, stochastic, and robust comparisons.</li>
</ul>
</div>
<div class="table-like">
<h3>Continuous Scenario Data: <code>hospital_demand_continuous.csv</code></h3>
<ul>
  <li>Created by <code>continuous_dataset.py</code>, which samples 1,000 scenarios from a hazard catalog (seasonal_flu, coastal_storm, earthquake, pandemic_wave).</li>
  <li>Demand is computed as baseline demand + sensitivity × global severity + correlated regional shock + idiosyncratic noise, where the 3×3 <code>BASE_COV</code> matrix controls cross-hospital covariance.</li>
  <li>Each scenario stores a severity score plus the decomposed global, regional, and idiosyncratic components, enabling box and ellipsoidal uncertainty sets.</li>
  <li>The generator also writes <code>hospital_demand_continuous_summary.json</code>, which reports scenario counts, total probability mass, hospital-level demand stats, and correlation matrices.</li>
</ul>
</div>
</div>

<div class="section">
<h2><code>code.ipynb</code>: Discrete Multi-Scenario Allocation Models</h2>
<p>This notebook reorganizes the discrete scenario data and compares four classical resource-allocation strategies:</p>
<ol>
  <li><strong>Perfect-Foresight Upper Bound</strong>: Solves an LP per scenario to establish a theoretical lower bound.</li>
  <li><strong>Two-Stage Stochastic Programming (SP)</strong>: Chooses global prepositioning first and dispatches surge stock (cap 120, cost multiplier 1.35) after observing the scenario.</li>
  <li><strong>Deterministic Expected-Value Plan</strong>: Optimizes against probability-weighted demand alone, ignoring variance.</li>
  <li><strong>Static Robust Allocation</strong>: Forces a single plan across scenarios and limits the maximum shortage with an auxiliary <code>worst_shortage</code> variable.</li>
</ol>

<div class="highlight">
<p><strong>Workflow highlights:</strong></p>
<ul>
  <li><em>Data prep</em>: Uses <code>pivot_table</code> to form a scenario × hospital matrix plus expected demand and utilization.</li>
  <li><em>Shared parameters</em>: TOTAL_PREPOSITION_STOCK = 220, SURGE_STOCK = 120, SURGE_COST_MULTIPLIER = 1.35, SHORTAGE_PENALTY = 8.</li>
  <li><em>Model utilities</em>: Functions like <code>_solution_to_frame</code> and <code>solve_and_report</code> standardize outputs while silencing solver logs.</li>
  <li><em>Evaluation</em>: Each model reports expected, worst-case, and 95th-percentile shortages and produces scenario-level frames for comparison.</li>
</ul>
</div>

<p>The notebook highlights the trade-offs among the discrete strategies: perfect-foresight offers a theoretical lower bound, the robust plan safeguards the worst cases, and SP balances expected performance with guarded risk.</p>
</div>

<div class="section">
<h2><code>continuous_models.ipynb</code>: Continuous Demand and Correlated Uncertainty Sets</h2>
<p>This notebook extends the discrete models into a more realistic continuous-demand world, adds exploratory data analysis (EDA), and tests alternative uncertainty sets.</p>

<h3>1. Environment and Data Overview</h3>
<ul>
  <li>Loads <code>hospital_demand_continuous.csv</code> with 1,000 scenarios and three hospitals.</li>
  <li>Builds <code>scenario_info</code>, <code>hospital_info</code>, and <code>demand_table</code>, verifying that scenario probabilities sum to 1.</li>
  <li>Computes hospital-level mean, std, and quantiles, plots histograms and correlation heatmaps, and visualizes how severity drives total demand.</li>
</ul>

<h3>2. Modeling Setup and Shared Utilities</h3>
<ul>
  <li>Shares the same resource caps and cost parameters but introduces utility functions such as <code>solution_to_frame</code>, <code>evaluate_static_plan</code>, and <code>compute_shortage_metrics</code>.</li>
  <li>Defines a <code>model_inputs</code> table with expected demand plus q90/q95/q99 levels that drive box-type constraints.</li>
</ul>

<h3>3. Model Family</h3>
<ol>
  <li><strong>Perfect-Foresight UB</strong>: Same intent as in the discrete notebook.</li>
  <li><strong>Two-Stage SP</strong>: Combines prepositioning and surge decisions and reports the highest surge use and shortage traces.</li>
  <li><strong>Deterministic Expected Plan</strong>: Relies on the continuous expected demand and evaluates realized shortages via <code>evaluate_static_plan</code>.</li>
  <li><strong>Box Robust (q0.975)</strong>: Enforces that each hospital can satisfy its 97.5th percentile demand, guarding marginal extremes.</li>
  <li><strong>Ellipsoid Robust</strong>: Builds stress points along eigen-directions (radius 1.8) to capture highly correlated joint surges.</li>
</ol>

<h3>4. Comparative Findings</h3>
<ul>
  <li>Constructs a <code>results_table</code> plus scenario-level shortage table and visualizes the efficient frontier of expected vs. worst-case shortages.</li>
  <li>Under the default settings, Box Robust achieves the lowest worst-case shortage (~44) with expected shortage around 0.42 but at the highest cost; Ellipsoid Robust respects correlation, costs ~268.9, and accepts a worst shortage near 71.</li>
</ul>
</div>

<div class="section">
<h2>Continuous Dataset Generation Details</h2>
<ol>
  <li><strong>Run the generator</strong>: Execute <code>python continuous_dataset.py</code> to create <code>hospital_demand_continuous.csv</code> and the companion summary JSON. The script defaults to 1,000 scenarios, a seeded RNG (<code>np.random.default_rng(42)</code>), and an optional calm baseline scenario.</li>
  <li><strong>Hazard catalog sampling</strong>: The function <code>_hazard_catalog()</code> defines four hazard types, each with weights, log-normal severity parameters (<code>mu</code>, <code>sigma</code>), a regional scaling factor for the shared covariance <code>BASE_COV</code>, and an idiosyncratic noise sigma. Scenarios are sampled in proportion to the hazard weights.</li>
  <li><strong>Severity construction</strong>: For every sampled hazard, the script draws a global severity from the specified log-normal distribution and converts it to a <code>severity_score = log(1 + global_severity)</code>. Regional shocks come from a multivariate normal distribution whose covariance is the hazard’s <code>region_scale</code> times <code>BASE_COV</code>, ensuring correlated surges across hospitals. Independent noise is added via a normal draw with the hazard-specific <code>idio_sigma</code>.</li>
  <li><strong>Demand formula and clipping</strong>: The hospital-level demand vector equals <code>baseline_demand + severity_sensitivity × global_severity + regional_component + idiosyncratic_component</code>. Negative values are clipped to zero and rounded to two decimals before being stored.</li>
  <li><strong>Probability calibration</strong>: Each draw receives a raw weight of <code>hazard_weight × (severity_score + 1e-6)</code>. Weights are normalized to probabilities, and if the calm baseline is included, the script explicitly reserves <code>BASELINE_PROBABILITY_SHARE = 0.35</code> of the mass for that scenario while proportionally scaling the remaining scenarios.</li>
  <li><strong>Output schema</strong>: The dataset is written in long form (one row per scenario–hospital pair) with columns for probabilities, disaster labels, severity components, hospital metadata, demand, and shortage penalties. <code>summarize_dataset()</code> then aggregates counts, total probability mass, descriptive statistics, and a demand correlation matrix into <code>hospital_demand_continuous_summary.json</code>.</li>
</ol>
</div>

<div class="section">
<h2>Notebook Crosswalk</h2>
<ul>
  <li><code>code.ipynb</code> offers the discrete scenario benchmark that illustrates how deterministic, stochastic, and robust philosophies differ.</li>
  <li><code>continuous_models.ipynb</code> addresses a higher-dimensional, continuous demand distribution and demonstrates box/ellipsoid uncertainty sets plus risk metrics.</li>
  <li>Both notebooks depend on a shared long-form schema (scenario ↔ hospital), making it easy to reuse model helpers and visualization patterns.</li>
  <li>For presentations, start with the discrete story to motivate need, then escalate to the continuous notebook to showcase advanced EDA and uncertainty modeling.</li>
</ul>
</div>

</body>
</html>
